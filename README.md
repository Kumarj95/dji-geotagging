# DJI Georeferencing

This project leverages log files and SRT files generated by DJI drones to do frame-by-frame georeferencing, giving us position and orientation information for the drone at each frame.


## Description

Drone based video has many uses including but not limited to:

- Photogrammetry
- Traffic Analytcis
- Surveillance
- Geolocation

However, DJI drones do not provide frame by frame orientation information about the drone in the SRT files. This serverely limits how useful the videos captured by the drone are. This project syncs the log file and the SRT files of a video and interpolates to give us frame by frame orientation information for each video.

DJI does provide frame-by-frame location information in the SRT file associated with each video. However, there are discrepencies between the SRT files and the Log files (parsed by [airdata](https://airdata.com/) or similar services). To remedy this we follow a 2 step heuresitc to sync the two files:

- Find all log file rows within a given threshold of the target SRT frame
- Among these rows find the first row that contains the target gimbal angle

We leverage the fact that most drone videos are shot at a specific gimbal angle (provided by the user) to get a correspondance between the log file and the SRT file.

## Getting Started

### Dependencies

* Ensure that [exiftool](https://exiftool.org/install.html) is installed if you would like to extract frames from the video and write metdata to them
    * Make a directory called Template and insert a sample image taken from the same drone as the video to copy the metadata format from the drone image to your saved frames
* [Python>=3.9](https://www.python.org/)



### Installing
```
 conda env create -f environment.yml
 conda activate geotagging
```

### Data preperation
This readme assumes the following structure
```
Data
   |——————LogFiles
   |        └——————logfile1.csv
   |        └——————logfile2.csv
   └——————SRTFiles
   |         └——————video1.srt
   |         └——————video2.srt
   |         └——————video3.srt
   |         └——————video4.srt
   └——————VideoFiles
   |        └——————video1.MP4
   |        └——————video2.MP4
   |        └——————video3.MP4
   |        └——————video4.MP4
   └——————Output
   |        └——————logfile1.json
   |        └——————logfile1_frames
   |                    └——————video1_{frame_idx:06d}.jpg
                                ....
   └——————Template
   |        └——————template_image.JPG (insert your template here)

        
   
```
### Executing program

Sample Usage
```
python3 src/main.py Data/LogFiles/logfile1.csv --SRTDir=Data/SRTFiles --VideoDir=Data/VideoFiles --SaveFrames  
        --FrameDirectory=Data/Output/logfile1_frames/ --SaveJson --JsonPath=Data/Output --Template=Data/Template/template_image.JPG
```

## Help

For full list of commands

```
python3 src/main.py -h
```

